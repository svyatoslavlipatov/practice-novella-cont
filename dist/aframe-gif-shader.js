/*! For license information please see aframe-gif-shader.js.LICENSE.txt */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.AFRAME_GIF=t():e.AFRAME_GIF=t()}(this,(()=>(()=>{"use strict";var e={208:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.loop=t.conditional=t.parse=void 0,t.parse=function e(t,r){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:i;if(Array.isArray(r))r.forEach((function(r){return e(t,r,i,a)}));else if("function"==typeof r)r(t,i,a,e);else{var n=Object.keys(r)[0];Array.isArray(r[n])?(a[n]={},e(t,r[n],i,a[n])):a[n]=r[n](t,i,a,e)}return i},t.conditional=function(e,t){return function(r,i,a,n){t(r,i,a)&&n(r,e,i,a)}},t.loop=function(e,t){return function(r,i,a,n){for(var s=[],o=r.pos;t(r,i,a);){var d={};if(n(r,e,i,d),r.pos===o)break;o=r.pos,s.push(d)}return s}}},253:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.deinterlace=void 0,t.deinterlace=function(e,t){for(var r=new Array(e.length),i=e.length/t,a=function(i,a){var n=e.slice(a*t,(a+1)*t);r.splice.apply(r,[i*t,t].concat(n))},n=[0,4,2,1],s=[8,8,4,2],o=0,d=0;d<4;d++)for(var c=n[d];c<i;c+=s[d])a(c,o),o++;return r}},270:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.lzw=void 0,t.lzw=function(e,t,r){var i,a,n,s,o,d,c,h,u,l,_,f,p,m,y,g,x=4096,v=r,w=new Array(r),b=new Array(x),A=new Array(x),C=new Array(4097);for(o=1+(a=1<<(l=e)),i=a+2,c=-1,n=(1<<(s=l+1))-1,h=0;h<a;h++)b[h]=0,A[h]=h;for(_=f=p=m=y=g=0,u=0;u<v;){if(0===m){if(f<s){_+=t[g]<<f,f+=8,g++;continue}if(h=_&n,_>>=s,f-=s,h>i||h==o)break;if(h==a){n=(1<<(s=l+1))-1,i=a+2,c=-1;continue}if(-1==c){C[m++]=A[h],c=h,p=h;continue}for(d=h,h==i&&(C[m++]=p,h=c);h>a;)C[m++]=A[h],h=b[h];p=255&A[h],C[m++]=p,i<x&&(b[i]=c,A[i]=p,!(++i&n)&&i<x&&(s++,n+=i)),c=d}m--,w[y++]=C[m],u++}for(u=y;u<v;u++)w[u]=0;return w}},393:(e,t,r)=>{t.Ud=t.O5=void 0;var i,a=(i=r(841))&&i.__esModule?i:{default:i},n=r(208),s=r(515),o=r(253),d=r(270);t.O5=function(e){var t=new Uint8Array(e);return(0,n.parse)((0,s.buildStream)(t),a.default)};t.Ud=function(e,t){return e.frames.filter((function(e){return e.image})).map((function(r){return function(e,t,r){if(e.image){var i=e.image,a=i.descriptor.width*i.descriptor.height,n=(0,d.lzw)(i.data.minCodeSize,i.data.blocks,a);i.descriptor.lct.interlaced&&(n=(0,o.deinterlace)(n,i.descriptor.width));var s={pixels:n,dims:{top:e.image.descriptor.top,left:e.image.descriptor.left,width:e.image.descriptor.width,height:e.image.descriptor.height}};return i.descriptor.lct&&i.descriptor.lct.exists?s.colorTable=i.lct:s.colorTable=t,e.gce&&(s.delay=10*(e.gce.delay||10),s.disposalType=e.gce.extras.disposal,e.gce.extras.transparentColorGiven&&(s.transparentIndex=e.gce.transparentColorIndex)),r&&(s.patch=function(e){for(var t=e.pixels.length,r=new Uint8ClampedArray(4*t),i=0;i<t;i++){var a=4*i,n=e.pixels[i],s=e.colorTable[n]||[0,0,0];r[a]=s[0],r[a+1]=s[1],r[a+2]=s[2],r[a+3]=n!==e.transparentIndex?255:0}return r}(s)),s}console.warn("gif frame does not have associated image.")}(r,e.gct,t)}))}},515:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.readBits=t.readArray=t.readUnsigned=t.readString=t.peekBytes=t.readBytes=t.peekByte=t.readByte=t.buildStream=void 0,t.buildStream=function(e){return{data:e,pos:0}};t.readByte=function(){return function(e){return e.data[e.pos++]}},t.peekByte=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return function(t){return t.data[t.pos+e]}};var r=function(e){return function(t){return t.data.subarray(t.pos,t.pos+=e)}};t.readBytes=r,t.peekBytes=function(e){return function(t){return t.data.subarray(t.pos,t.pos+e)}},t.readString=function(e){return function(t){return Array.from(r(e)(t)).map((function(e){return String.fromCharCode(e)})).join("")}},t.readUnsigned=function(e){return function(t){var i=r(2)(t);return e?(i[1]<<8)+i[0]:(i[0]<<8)+i[1]}},t.readArray=function(e,t){return function(i,a,n){for(var s="function"==typeof t?t(i,a,n):t,o=r(e),d=new Array(s),c=0;c<s;c++)d[c]=o(i);return d}},t.readBits=function(e){return function(t){for(var r=function(e){return e.data[e.pos++]}(t),i=new Array(8),a=0;a<8;a++)i[7-a]=!!(r&1<<a);return Object.keys(e).reduce((function(t,r){var a=e[r];return a.length?t[r]=function(e,t,r){for(var i=0,a=0;a<r;a++)i+=e[t+a]&&Math.pow(2,r-a-1);return i}(i,a.index,a.length):t[r]=i[a.index],t}),{})}}},841:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=r(208),a=r(515),n={blocks:function(e){for(var t=[],r=e.data.length,i=0,n=(0,a.readByte)()(e);0!==n&&n;n=(0,a.readByte)()(e)){if(e.pos+n>=r){var s=r-e.pos;t.push((0,a.readBytes)(s)(e)),i+=s;break}t.push((0,a.readBytes)(n)(e)),i+=n}for(var o=new Uint8Array(i),d=0,c=0;c<t.length;c++)o.set(t[c],d),d+=t[c].length;return o}},s=(0,i.conditional)({gce:[{codes:(0,a.readBytes)(2)},{byteSize:(0,a.readByte)()},{extras:(0,a.readBits)({future:{index:0,length:3},disposal:{index:3,length:3},userInput:{index:6},transparentColorGiven:{index:7}})},{delay:(0,a.readUnsigned)(!0)},{transparentColorIndex:(0,a.readByte)()},{terminator:(0,a.readByte)()}]},(function(e){var t=(0,a.peekBytes)(2)(e);return 33===t[0]&&249===t[1]})),o=(0,i.conditional)({image:[{code:(0,a.readByte)()},{descriptor:[{left:(0,a.readUnsigned)(!0)},{top:(0,a.readUnsigned)(!0)},{width:(0,a.readUnsigned)(!0)},{height:(0,a.readUnsigned)(!0)},{lct:(0,a.readBits)({exists:{index:0},interlaced:{index:1},sort:{index:2},future:{index:3,length:2},size:{index:5,length:3}})}]},(0,i.conditional)({lct:(0,a.readArray)(3,(function(e,t,r){return Math.pow(2,r.descriptor.lct.size+1)}))},(function(e,t,r){return r.descriptor.lct.exists})),{data:[{minCodeSize:(0,a.readByte)()},n]}]},(function(e){return 44===(0,a.peekByte)()(e)})),d=(0,i.conditional)({text:[{codes:(0,a.readBytes)(2)},{blockSize:(0,a.readByte)()},{preData:function(e,t,r){return(0,a.readBytes)(r.text.blockSize)(e)}},n]},(function(e){var t=(0,a.peekBytes)(2)(e);return 33===t[0]&&1===t[1]})),c=(0,i.conditional)({application:[{codes:(0,a.readBytes)(2)},{blockSize:(0,a.readByte)()},{id:function(e,t,r){return(0,a.readString)(r.blockSize)(e)}},n]},(function(e){var t=(0,a.peekBytes)(2)(e);return 33===t[0]&&255===t[1]})),h=(0,i.conditional)({comment:[{codes:(0,a.readBytes)(2)},n]},(function(e){var t=(0,a.peekBytes)(2)(e);return 33===t[0]&&254===t[1]})),u=[{header:[{signature:(0,a.readString)(3)},{version:(0,a.readString)(3)}]},{lsd:[{width:(0,a.readUnsigned)(!0)},{height:(0,a.readUnsigned)(!0)},{gct:(0,a.readBits)({exists:{index:0},resolution:{index:1,length:3},sort:{index:4},size:{index:5,length:3}})},{backgroundColorIndex:(0,a.readByte)()},{pixelAspectRatio:(0,a.readByte)()}]},(0,i.conditional)({gct:(0,a.readArray)(3,(function(e,t){return Math.pow(2,t.lsd.gct.size+1)}))},(function(e,t){return t.lsd.gct.exists})),{frames:(0,i.loop)([s,c,h,o,d],(function(e){var t=(0,a.peekByte)()(e);return 33===t||44===t}))}];t.default=u}},t={},r=function r(i){var a=t[i];if(void 0!==a)return a.exports;var n=t[i]={exports:{}};return e[i](n,n.exports,r),n.exports}(393);class i{static parseGIF(e){return(0,r.O5)(e)}static decompressFrames(e){return(0,r.Ud)(e,!0)}}return function(){if(!window.AFRAME)return;const e=window.AFRAME.THREE,t=e.WebGLRenderer;t.__patched||(e.WebGLRenderer=function(e){const r=new t(e);return Object.defineProperty(r,"useLegacyLights",{get:()=>!1,set:()=>{}}),r},e.WebGLRenderer.prototype=t.prototype,Object.setPrototypeOf(e.WebGLRenderer,t),e.WebGLRenderer.__patched=!0)}(),function(){const e=window.AFRAME.THREE;window.AFRAME.registerComponent("gif-shader",{schema:{color:{type:"color"},fog:{default:!0},src:{default:null},autoplay:{default:!0},opacity:{type:"number",default:1},alphaTest:{type:"number",default:0},repeat:{type:"vec2",default:{x:1,y:1}},depthTest:{default:!0},depthWrite:{default:!0},transparent:{default:!0}},init:function(){this.__cnv=document.createElement("canvas"),this.__cnv.width=2,this.__cnv.height=2,this.__ctx=this.__cnv.getContext("2d",{willReadFrequently:!0}),this.__texture=new e.Texture(this.__cnv),this.__texture.minFilter=e.LinearFilter,this.__texture.magFilter=e.LinearFilter,this.__texture.generateMipmaps=!1,this.__texture.colorSpace=e.SRGBColorSpace,this.__texture.wrapS=e.RepeatWrapping,this.__texture.wrapT=e.RepeatWrapping,this.__texture.premultiplyAlpha=!0,this.__texture.flipY=!0,this.__texture.format=e.RGBAFormat,this.__frameIdx=0,this.__frameCnt=0,this.__delayTimes=null,this.__frames=null,this.__autoplay=!1!==this.data.autoplay,this.__paused=!this.__autoplay,this.__textureSrc=null,this.__startTime=0,this.__nextFrameTime=0,this.__offscreenCanvas=document.createElement("canvas"),this.__offscreenCanvas.width=2,this.__offscreenCanvas.height=2,this.__offscreenCtx=this.__offscreenCanvas.getContext("2d",{willReadFrequently:!0}),this.material=new e.MeshBasicMaterial({map:this.__texture,transparent:!0,side:e.DoubleSide,fog:this.data.fog,opacity:1,alphaTest:this.data.alphaTest,depthTest:this.data.depthTest,depthWrite:this.data.depthWrite,color:new e.Color(this.data.color)}),this.data.repeat&&this.__texture.repeat.set(this.data.repeat.x,this.data.repeat.y);const t=()=>{const e=this.el.getObject3D("mesh");e&&(Array.isArray(e.material)?e.material=e.material.map((()=>this.material)):e.material=this.material)};this.el.hasLoaded?(t(),this.data.src&&this.__loadGif(this.data.src)):this.el.addEventListener("loaded",(()=>{t(),this.data.src&&this.__loadGif(this.data.src)}))},tick:function(e,t){if(this.__frames&&this.__delayTimes&&!this.__paused)return 0===this.__startTime?(this.__startTime=e,void(this.__nextFrameTime=e+this.__delayTimes[0])):void(e>=this.__nextFrameTime&&(this.__frameIdx=(this.__frameIdx+1)%this.__frameCnt,this.__nextFrameTime+=this.__delayTimes[0],e-this.__nextFrameTime>1e3&&(this.__nextFrameTime=e+this.__delayTimes[0]),this.__updateTexture()))},__loadGif:function(e){let t=e;if(t.split("/").pop(),e.startsWith("#")){const r=document.querySelector(e);if(!r||!r.src)return void console.error("Asset not found:",e);t=r.src}t=function(e){if(!e)return"";if(e.startsWith("#")){const t=document.querySelector(e);if(t){if(t instanceof HTMLImageElement&&t.src)return t.src;if(t instanceof HTMLCanvasElement)return t.toDataURL();if(t.getAttribute("src"))return t.getAttribute("src")||""}}return e.startsWith("url(")&&e.endsWith(")")&&(e=e.slice(4,-1).replace(/['"]/g,"")),e.startsWith("http://")||e.startsWith("https://")||e.startsWith("data:")||(e=window.location.pathname.substring(0,window.location.pathname.lastIndexOf("/")+1)+e),e}(t),t?fetch(t).then((e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.arrayBuffer()})).then((t=>{const r=i.parseGIF(t),a=i.decompressFrames(r),n=a.map((e=>e.delay)),s=n.reduce(((e,t)=>e+t),0)/n.length,o=new Array(n.length).fill(s),d=a[0];this.__cnv.width=d.dims.width,this.__cnv.height=d.dims.height,this.__offscreenCanvas.width=d.dims.width,this.__offscreenCanvas.height=d.dims.height,this.data.repeat&&this.__texture.repeat.set(this.data.repeat.x,this.data.repeat.y),this.__frames=a,this.__delayTimes=o,this.__frameCnt=a.length,this.__frameIdx=0,this.__textureSrc=e,this.__updateTexture(),this.__autoplay&&this.play()})).catch((e=>{console.error("Failed to load GIF:",e),this.__reset()})):console.error("Invalid GIF URL:",e)},__updateTexture:function(){if(!this.__frames||!this.__ctx||!this.__offscreenCtx)return;const e=this.__frames[this.__frameIdx];if(e)try{const t=document.createElement("canvas");t.width=e.dims.width,t.height=e.dims.height;const r=t.getContext("2d",{willReadFrequently:!0,alpha:!0});if(!r)return;const i=new ImageData(e.patch,e.dims.width,e.dims.height);r.putImageData(i,0,0),2===e.disposalType||0===this.__frameIdx?this.__ctx.clearRect(e.dims.left-1,e.dims.top-1,e.dims.width+2,e.dims.height+2):(this.__ctx.globalCompositeOperation="copy",this.__ctx.drawImage(this.__offscreenCanvas,0,0),this.__ctx.globalCompositeOperation="source-over"),this.__ctx.drawImage(t,0,0,e.dims.width,e.dims.height,e.dims.left,e.dims.top,e.dims.width,e.dims.height),this.__offscreenCtx.clearRect(0,0,this.__offscreenCanvas.width,this.__offscreenCanvas.height),this.__offscreenCtx.drawImage(this.__cnv,0,0),this.__texture.needsUpdate=!0}catch(e){console.error("Error updating frame:",e)}},__reset:function(){this.__frames=null,this.__delayTimes=null,this.__frameCnt=0,this.__frameIdx=0,this.__textureSrc=null,this.__startTime=0,this.__nextFrameTime=0},__clearCanvas:function(){this.__ctx&&this.__ctx.clearRect(0,0,this.__cnv.width,this.__cnv.height),this.__offscreenCtx&&this.__offscreenCtx.clearRect(0,0,this.__offscreenCanvas.width,this.__offscreenCanvas.height),this.__texture&&(this.__texture.needsUpdate=!0)},play:function(){this.__paused=!1,this.__startTime=0},pause:function(){this.__paused=!0},togglePlayback:function(){this.__paused?this.play():this.pause()}})}(),window.AFRAME.registerComponent("gif",{schema:{src:{type:"string"},autoplay:{default:!0},shader:{default:"gif"},repeat:{type:"vec2",default:{x:1,y:1}}},init(){this.el.setAttribute("gif-shader",{src:this.data.src,autoplay:this.data.autoplay,repeat:this.data.repeat})},update(e={}){var t,r;const i=this.data;i.src!==e.src&&this.el.setAttribute("gif-shader","src",i.src),i.autoplay!==e.autoplay&&this.el.setAttribute("gif-shader","autoplay",i.autoplay),!i.repeat||(null===(t=e.repeat)||void 0===t?void 0:t.x)===i.repeat.x&&(null===(r=e.repeat)||void 0===r?void 0:r.y)===i.repeat.y||this.el.setAttribute("gif-shader","repeat",i.repeat)},remove(){this.el.removeAttribute("gif-shader")},play(){const e=this.el.components["gif-shader"];e&&e.play()},pause(){const e=this.el.components["gif-shader"];e&&e.pause()},tick(e,t){const r=this.el.components["gif-shader"];r&&"function"==typeof r.tick&&r.tick(e,t)}}),{}})()));
//# sourceMappingURL=aframe-gif-shader.js.map